<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>AQI - ‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Kanit', sans-serif;
      background-color: #f5f5f5;
      height: 100%;
      overflow: hidden;
    }

h1 {
  text-align: center;
  margin: 16px 10px 8px;
  color: #333;
  font-size: 16px; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  font-weight: 600;
}
    #container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      padding: 0 10px 20px 10px;
      max-width: 1200px;
      margin: 0 auto 30px;
      max-height: 90vh;
      overflow: hidden;
    }

    #info-container {
      width: 320px;
      min-width: 280px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 14px;
      color: #222;
      line-height: 1.4;
      max-height: 90vh;
      overflow-y: auto;
    }

    #info-container h2 {
      font-size: 18px;
      margin: 16px 0 8px;
    }

    .aqi-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 12px;
    }

    .aqi-table th, .aqi-table td {
      border-bottom: 1px solid #eee;
      padding: 6px 8px;
      text-align: center;
      font-size: 13px;
    }

    #stations {
      max-height: 150px;
      overflow-y: auto;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      margin-top: 10px;
    }

    .station-item {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-weight: 600;
      font-size: 13px;
    }

    .station-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60%;
    }

    #map {
      flex-grow: 1;
      max-height: 90vh;
      min-height: auto;
      overflow: auto;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î popup leaflet */
    .leaflet-popup-content {
      font-size: 16px;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πÄ‡∏Å‡∏•‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
    @media (max-width: 768px) {
      #container {
        flex-direction: column;
        height: auto;
      }
      #map {
        order: 1; /* ‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å */
        height: 300px;
      }
      #info-container {
        order: 2;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding: 12px 10px;
        max-height: none;
        height: auto;
        margin-bottom: 10px;
      }

      .leaflet-popup-content {
        font-size: 14px;  /* popup ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      }

      .aqi-table th, .aqi-table td {
        font-size: 11px;
        padding: 4px 6px;
      }

      .station-item {
        font-size: 11px;
      }
    }

#back-button {
  display: inline-block;
  position: absolute;
  top: 16px;
  left: 32px; /* ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∑‡∏≠ 16px ‚Üí ‡∏Ç‡∏¢‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
  padding: 8px 16px; /* ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
  border-radius: 8px;
  text-decoration: none;
  color: #333;
  font-weight: bold;
  font-size: 16px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 14px */
  z-index: 999;
  transition: background-color 0.2s;
}

#back-button:hover {
  background-color: #eee;
}


    .aqi-number-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      pointer-events: none;
      user-select: none;
    }

    .aqi-label {
      font-weight: bold;
      color: #000;
      text-align: center;
      line-height: 1;
      /* font-size ‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ô JS */
    }
  </style>
</head>
<body>
  <a href="/opening" id="back-button">&lt;</a>
  <h1>‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô</h1>

  <div id="container">
    <div id="info-container" role="region" aria-label="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ AQI">
      <p>‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (Air Quality Index - AQI) ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏•‡∏û‡∏¥‡∏©‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡∏°‡∏•‡∏û‡∏¥‡∏©‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏ä‡πà‡∏ô PM2.5 ‡∏ã‡∏∂‡πà‡∏á‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô 6 ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ AQI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</p>

      <h2>‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</h2>
      <table class="aqi-table" aria-label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö AQI">
        <thead>
          <tr><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏Ñ‡πà‡∏≤ AQI</th><th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</th></tr>
        </thead>
        <tbody>
          <tr><td>üòÉ</td><td>0‚Äì12</td><td>‡∏î‡∏µ</td></tr>
          <tr><td>üôÇ</td><td>12.1‚Äì35.4</td><td>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</td></tr>
          <tr><td>üòê</td><td>35.5‚Äì55.4</td><td>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•</td></tr>
          <tr><td>üò∑</td><td>55.5‚Äì150.4</td><td>‡πÑ‡∏°‡πà‡∏î‡∏µ</td></tr>
          <tr><td>ü§¢</td><td>150.5‚Äì250.4</td><td>‡πÅ‡∏¢‡πà‡∏°‡∏≤‡∏Å</td></tr>
          <tr><td>‚ò†Ô∏è</td><td>250.5+</td><td>‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</td></tr>
        </tbody>
      </table>

      <h2>üìç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ AQI</h2>
      <div id="stations" aria-live="polite" aria-relevant="additions"></div>
    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const mapCenter = [19.3022, 97.9654];
    const defaultZoom = 10;
    const mobileZoom = 7;

    const map = L.map('map', {
      center: mapCenter,
      zoom: defaultZoom,
      zoomControl: true,
      dragging: true,
      touchZoom: true,
      scrollWheelZoom: true,
      doubleClickZoom: true,
      boxZoom: true,
      tap: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡πÄ‡∏Å‡∏•‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    function getCircleRadius() {
      return window.innerWidth <= 768 ? 12 : 20;
    }

    function getIconSize() {
      return window.innerWidth <= 768 ? 24 : 40;
    }

    function getIconAnchor() {
      return window.innerWidth <= 768 ? [12, 12] : [20, 20];
    }

    function getLabelFontSize() {
      return window.innerWidth <= 768 ? '12px' : '14px';
    }

    function getStationNameFontSize() {
      return window.innerWidth <= 768 ? '10px' : '12px';
    }

    function getPopupFontSize() {
      return window.innerWidth <= 768 ? '14px' : '16px';
    }

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î popup Leaflet ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏Å‡∏•
    function adjustPopupFontSize() {
      const css = `.leaflet-popup-content { font-size: ${getPopupFontSize()} !important; }`;
      let styleEl = document.getElementById('popup-style');
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'popup-style';
        document.head.appendChild(styleEl);
      }
      styleEl.innerHTML = css;
    }

    // ‡∏õ‡∏£‡∏±‡∏ö zoom ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    function adjustMapZoom() {
      if (window.innerWidth <= 768) {
        map.setZoom(mobileZoom);
      } else {
        map.setZoom(defaultZoom);
      }
    }

    window.addEventListener('load', () => {
      adjustMapZoom();
      adjustPopupFontSize();
      fetchStations();
    });

    window.addEventListener('resize', () => {
      adjustMapZoom();
      adjustPopupFontSize();
      // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ markers ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡πÉ‡∏ô‡∏ô‡∏µ‡πâ)
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏° PM2.5
    function getColorByPM25(pm) {
      if (typeof pm !== "number") return '#999999';
      return pm <= 12 ? '#00e400' :
             pm <= 35.4 ? '#ffff00' :
             pm <= 55.4 ? '#ff7e00' :
             pm <= 150.4 ? '#ff0000' :
             pm <= 250.4 ? '#8f3f97' :
                           '#7e0023';
    }

    function getFaceEmoji(pm) {
      if (typeof pm !== "number") return '‚ùì';
      return pm <= 12 ? 'üòÉ' :
             pm <= 35.4 ? 'üôÇ' :
             pm <= 55.4 ? 'üòê' :
             pm <= 150.4 ? 'üò∑' :
             pm <= 250.4 ? 'ü§¢' :
                           '‚ò†Ô∏è';
    }

    const cityCoords = {
      "Mae Hi": [19.5, 97.8],
      "Pai": [19.358, 98.436],
      "Pang Mu": [19.144, 97.761],
      "Wiang Nuea": [19.697, 97.983]
    };

    async function fetchStations() {
      try {
        const response = await fetch('/api/maehongson_stations', { cache: 'no-store' });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();

        if (data.error) {
          alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ AQI: " + data.error);
          return;
        }
        if (!data.stations || data.stations.length === 0) {
          alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ AQI ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á");
          return;
        }

        data.stations.sort((a, b) => a.aqius - b.aqius);

        const stationListEl = document.getElementById("stations");
        stationListEl.innerHTML = '';

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° markers
        data.stations.forEach(station => {
          const coords = cityCoords[station.city];
          if (!coords) return;

          const aqi = station.aqius;
          const emoji = getFaceEmoji(aqi);
          const color = getColorByPM25(aqi);

          // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ ‡∏õ‡∏£‡∏±‡∏ö radius ‡∏ï‡∏≤‡∏°‡∏™‡πÄ‡∏Å‡∏•
          const circle = L.circleMarker(coords, {
            radius: getCircleRadius(),
            color: '#000',
            fillColor: color,
            fillOpacity: 0.5,
            weight: 1
          }).addTo(map);

          // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç AQI ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î font ‡πÅ‡∏•‡∏∞ icon
          const aqiNumberIcon = L.divIcon({
            className: 'aqi-number-icon',
            html: `<div class="aqi-label" style="font-size:${getLabelFontSize()}">${aqi}</div>`,
            iconSize: [getIconSize(), getIconSize()],
            iconAnchor: getIconAnchor()
          });
          L.marker(coords, { icon: aqiNumberIcon, interactive: false }).addTo(map);

          // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡πÉ‡∏ï‡πâ‡∏à‡∏∏‡∏î ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå
          const stationNameIcon = L.divIcon({
            className: '',
            html: `<div style="
              color:#222;
              font-weight: 600;
              font-size: ${getStationNameFontSize()};
              margin-top: 4px;
              text-align: center;
              white-space: nowrap;
              user-select:none;
              pointer-events:none;
              max-width: 100px;
              overflow: hidden;
              text-overflow: ellipsis;
            ">${station.city}</div>`,
            iconSize: [100, 20],
            iconAnchor: [50, -10]
          });
          const nameLatLng = L.latLng(coords[0] - 0.0025, coords[1]);
          L.marker(nameLatLng, {icon: stationNameIcon, interactive: false}).addTo(map);

          // popup ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          circle.bindPopup(`
            <strong>${station.city}</strong><br>
            AQI (US): ${aqi}<br>
            ‡∏ï‡∏±‡∏ß‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å: ${station.main_pollutant?.toUpperCase() || 'N/A'}<br>
            ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: ${station.temperature ?? 'N/A'} ¬∞C<br>
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: ${station.humidity ?? 'N/A'} %<br>
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°: ${station.wind_speed ?? 'N/A'} m/s
          `);

          // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á
          const listItem = document.createElement('div');
          listItem.className = 'station-item';
          listItem.innerHTML = `
            <span class="station-name" title="${station.city}">${station.city}</span>
            <span style="color:${color}">${aqi} ${emoji}</span>
          `;
          stationListEl.appendChild(listItem);
        });
      } catch (err) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ AQI ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ AQI ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message);
      }
    }
  </script>
</body>
</html>
